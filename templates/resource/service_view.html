{% extends "base.html" %}

{% block title %}서비스 정보 - AWS 콘솔 체크{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/resource/service-view.css') }}">
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>AWS 서비스 정보</h1>
    <a href="{{ url_for('resource_collections_view') }}" class="awsui-button awsui-button-normal">
        <i class="fas fa-arrow-left me-2"></i>수집 데이터 목록으로 돌아가기
    </a>
</div>

<div class="collection-info mb-3">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <button class="awsui-button awsui-button-primary toggle-sections-btn" id="toggle-sections-btn">
                <i class="fas fa-chevron-down"></i><span id="toggle-btn-text">모두 접기</span>
            </button>
            
            <div class="btn-group ms-2">
                <button class="export-button" data-format="json" id="export-json">
                    <i class="fas fa-file-download"></i> JSON 내보내기
                </button>
                <button class="export-button" data-format="csv" id="export-csv">
                    <i class="fas fa-file-csv"></i> CSV 내보내기
                </button>
            </div>
        </div>
        <div>
            {% if collection_id %}
            <span class="badge bg-info me-2">수집 ID: {{ collection_id }}</span>
            {% endif %}
            {% if collection_timestamp %}
            <span class="badge bg-secondary me-2">수집 시간: {{ collection_timestamp|replace('T', ' ')|truncate(19, True, '') }}</span>
            {% endif %}
        </div>
    </div>
</div>

{% if all_services_data %}
<!-- EC2 서비스 섹션 -->
{% if 'ec2' in selected_services and all_services_data.ec2 %}
<div class="service-section" id="ec2-section">
    <div class="service-section-header" data-bs-target="#ec2-content" aria-expanded="true">
        <h3>
            <i class="fas fa-server"></i>
            EC2 인스턴스
        </h3>
        <div class="toggle-icon">
            <i class="fas fa-chevron-down"></i>
        </div>
    </div>
    <div class="service-section-body collapse show" id="ec2-content">
        <!-- EC2 요약 정보 -->
        {% if all_services_data.ec2.summary %}
        <div class="summary-cards">
            <div class="summary-card">
                <div class="summary-card-title">총 인스턴스</div>
                <div class="summary-card-value">{{ all_services_data.ec2.summary.total_instances }}</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-title">실행 중</div>
                <div class="summary-card-value">{{ all_services_data.ec2.summary.running_instances }}</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-title">중지됨</div>
                <div class="summary-card-value">{{ all_services_data.ec2.summary.stopped_instances }}</div>
            </div>
        </div>
        
        <!-- 인스턴스 유형별 분포 -->
        {% if all_services_data.ec2.summary.instance_types %}
        <div class="chart-container">
            <div class="chart-title">인스턴스 유형별 분포</div>
            <div class="table-responsive">
                <table class="resource-table">
                    <thead>
                        <tr>
                            <th>인스턴스 유형</th>
                            <th>총 개수</th>
                            <th>실행 중</th>
                            <th>중지됨</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for type, data in all_services_data.ec2.summary.instance_types.items() %}
                        <tr>
                            <td><strong>{{ type }}</strong></td>
                            <td>{{ data.count }}</td>
                            <td>{{ data.running }}</td>
                            <td>{{ data.stopped }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
        
        <!-- 가용 영역별 분포 -->
        {% if all_services_data.ec2.summary.az_distribution %}
        <div class="chart-container">
            <div class="chart-title">가용 영역별 분포</div>
            <div class="table-responsive">
                <table class="resource-table">
                    <thead>
                        <tr>
                            <th>가용 영역</th>
                            <th>총 개수</th>
                            <th>실행 중</th>
                            <th>중지됨</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for az, data in all_services_data.ec2.summary.az_distribution.items() %}
                        <tr>
                            <td><strong>{{ az }}</strong></td>
                            <td>{{ data.count }}</td>
                            <td>{{ data.running }}</td>
                            <td>{{ data.stopped }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
        {% endif %}
        
        <!-- EC2 인스턴스 목록 -->
        {% if all_services_data.ec2.instances %}
        <div class="filter-container">
            <input type="text" class="filter-input" id="ec2-filter" data-table="ec2-table" placeholder="인스턴스 필터링...">
        </div>
        <div class="table-responsive">
            <table class="resource-table" id="ec2-table">
                <thead>
                    <tr>
                        <th data-sort="id">인스턴스 ID</th>
                        <th data-sort="type">유형</th>
                        <th data-sort="state">상태</th>
                        <th data-sort="az">가용 영역</th>
                        <th data-sort="cpu">CPU 사용률</th>
                        <th data-sort="network">네트워크</th>
                        <th data-sort="launch_time">시작 시간</th>
                        <th>상세 정보</th>
                    </tr>
                </thead>
                <tbody>
                    {% for instance in all_services_data.ec2.instances %}
                    <tr>
                        <td data-column="id">{{ instance.id }}</td>
                        <td data-column="type">{{ instance.type }}</td>
                        <td data-column="state">
                            <span class="status-badge {% if instance.state == 'running' %}status-running{% elif instance.state == 'stopped' %}status-stopped{% else %}status-pending{% endif %}">
                                {{ instance.state }}
                            </span>
                        </td>
                        <td data-column="az">{{ instance.az }}</td>
                        <td data-column="cpu">
                            {% if instance.cpu_utilization is defined and instance.cpu_utilization is not none %}
                            <div>{{ "%.1f"|format(instance.cpu_utilization|float) }}%</div>
                            <div class="metric-gauge">
                                <div class="metric-gauge-fill {% if instance.cpu_utilization < 30 %}low{% elif instance.cpu_utilization < 70 %}medium{% else %}high{% endif %}" style="width: {{ instance.cpu_utilization }}%;"></div>
                            </div>
                            {% else %}
                            N/A
                            {% endif %}
                        </td>
                        <td data-column="network">
                            {% if instance.network_in is defined and instance.network_out is defined %}
                            <div>In: {{ "%.2f"|format(instance.network_in|float) }} MB</div>
                            <div>Out: {{ "%.2f"|format(instance.network_out|float) }} MB</div>
                            {% else %}
                            N/A
                            {% endif %}
                        </td>
                        <td data-column="launch_time">{{ instance.launch_time|replace('T', ' ')|truncate(19, True, '') }}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary detail-toggle" data-target="instance-detail-{{ loop.index }}">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </td>
                    </tr>
                    <tr id="instance-detail-{{ loop.index }}" style="display: none;">
                        <td colspan="8">
                            <div class="detail-panel">
                                <!-- 인스턴스 상세 정보 탭 -->
                                <div class="resource-tabs">
                                    <div class="resource-tab active" data-tab="instance-info-{{ loop.index }}">기본 정보</div>
                                    <div class="resource-tab" data-tab="instance-network-{{ loop.index }}">네트워크</div>
                                    <div class="resource-tab" data-tab="instance-storage-{{ loop.index }}">스토리지</div>
                                    <div class="resource-tab" data-tab="instance-security-{{ loop.index }}">보안</div>
                                    <div class="resource-tab" data-tab="instance-tags-{{ loop.index }}">태그</div>
                                </div>
                                
                                <!-- 기본 정보 탭 -->
                                <div class="resource-tab-content active" id="instance-info-{{ loop.index }}">
                                    <div class="detail-panel-row">
                                        <div class="detail-panel-label">인스턴스 ID</div>
                                        <div class="detail-panel-value">{{ instance.id }}</div>
                                    </div>
                                    <div class="detail-panel-row">
                                        <div class="detail-panel-label">인스턴스 유형</div>
                                        <div class="detail-panel-value">{{ instance.type }}</div>
                                    </div>
                                    <div class="detail-panel-row">
                                        <div class="detail-panel-label">상태</div>
                                        <div class="detail-panel-value">{{ instance.state }}</div>
                                    </div>
                                    <div class="detail-panel-row">
                                        <div class="detail-panel-label">가용 영역</div>
                                        <div class="detail-panel-value">{{ instance.az }}</div>
                                    </div>
                                    <div class="detail-panel-row">
                                        <div class="detail-panel-label">시작 시간</div>
                                        <div class="detail-panel-value">{{ instance.launch_time|replace('T', ' ')|truncate(19, True, '') }}</div>
                                    </div>
                                    <div class="detail-panel-row">
                                        <div class="detail-panel-label">아키텍처</div>
                                        <div class="detail-panel-value">{{ instance.architecture|default('N/A') }}</div>
                                    </div>
                                    <div class="detail-panel-row">
                                        <div class="detail-panel-label">하이퍼바이저</div>
                                        <div class="detail-panel-value">{{ instance.hypervisor|default('N/A') }}</div>
                                    </div>
                                    <div class="detail-panel-row">
                                        <div class="detail-panel-label">루트 디바이스 유형</div>
                                        <div class="detail-panel-value">{{ instance.root_device_type|default('N/A') }}</div>
                                    </div>
                                    <div class="detail-panel-row">
                                        <div class="detail-panel-label">루트 디바이스 이름</div>
                                        <div class="detail-panel-value">{{ instance.root_device_name|default('N/A') }}</div>
                                    </div>
                                    <div class="detail-panel-row">
                                        <div class="detail-panel-label">가상화 유형</div>
                                        <div class="detail-panel-value">{{ instance.virtualization_type|default('N/A') }}</div>
                                    </div>
                                </div>
                                
                                <!-- 네트워크 탭 -->
                                <div class="resource-tab-content" id="instance-network-{{ loop.index }}">
                                    {% if instance.network_interfaces %}
                                    <div class="detail-panel-title">네트워크 인터페이스</div>
                                    {% for ni in instance.network_interfaces %}
                                    <div class="security-rule">
                                        <div class="security-rule-header">
                                            <div class="security-rule-title">{{ ni.id }}</div>
                                            <div class="security-rule-ports">{{ ni.status }}</div>
                                        </div>
                                        <div class="detail-panel-row">
                                            <div class="detail-panel-label">서브넷 ID</div>
                                            <div class="detail-panel-value">{{ ni.subnet_id }}</div>
                                        </div>
                                        <div class="detail-panel-row">
                                            <div class="detail-panel-label">VPC ID</div>
                                            <div class="detail-panel-value">{{ ni.vpc_id }}</div>
                                        </div>
                                        <div class="detail-panel-row">
                                            <div class="detail-panel-label">프라이빗 IP</div>
                                            <div class="detail-panel-value">{{ ni.private_ip }}</div>
                                        </div>
                                        <div class="detail-panel-row">
                                            <div class="detail-panel-label">퍼블릭 IP</div>
                                            <div class="detail-panel-value">{{ ni.public_ip|default('N/A') }}</div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                    {% else %}
                                    <div class="empty-state">
                                        <p>네트워크 인터페이스 정보가 없습니다.</p>
                                    </div>
                                    {% endif %}
                                    
                                    {% if instance.network_trend %}
                                    <div class="detail-panel-title mt-3">네트워크 트래픽 추세</div>
                                    <div class="table-responsive">
                                        <table class="resource-table">
                                            <thead>
                                                <tr>
                                                    <th>시간</th>
                                                    <th>인바운드 (MB)</th>
                                                    <th>아웃바운드 (MB)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for point in instance.network_trend %}
                                                <tr>
                                                    <td>{{ point.timestamp|replace('T', ' ')|truncate(19, True, '') }}</td>
                                                    <td>{{ "%.2f"|format(point.in|float) }}</td>
                                                    <td>{{ "%.2f"|format(point.out|float) }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- 스토리지 탭 -->
                                <div class="resource-tab-content" id="instance-storage-{{ loop.index }}">
                                    {% if instance.volumes %}
                                    <div class="detail-panel-title">EBS 볼륨</div>
                                    {% for volume in instance.volumes %}
                                    <div class="volume-info">
                                        <div class="volume-info-header">
                                            <div class="volume-info-title">{{ volume.volume_id }}</div>
                                            <div class="volume-info-size">{{ volume.size }} GB</div>
                                        </div>
                                        <div class="detail-panel-row">
                                            <div class="detail-panel-label">볼륨 유형</div>
                                            <div class="detail-panel-value">{{ volume.volume_type }}</div>
                                        </div>
                                        <div class="detail-panel-row">
                                            <div class="detail-panel-label">IOPS</div>
                                            <div class="detail-panel-value">{{ volume.iops|default('N/A') }}</div>
                                        </div>
                                        <div class="detail-panel-row">
                                            <div class="detail-panel-label">처리량</div>
                                            <div class="detail-panel-value">{{ volume.throughput|default('N/A') }} MiB/s</div>
                                        </div>
                                        <div class="detail-panel-row">
                                            <div class="detail-panel-label">암호화</div>
                                            <div class="detail-panel-value">{{ '예' if volume.encrypted else '아니오' }}</div>
                                        </div>
                                        <div class="detail-panel-row">
                                            <div class="detail-panel-label">상태</div>
                                            <div class="detail-panel-value">{{ volume.state }}</div>
                                        </div>
                                        <div class="detail-panel-row">
                                            <div class="detail-panel-label">생성 시간</div>
                                            <div class="detail-panel-value">{{ volume.create_time|replace('T', ' ')|truncate(19, True, '') }}</div>
                                        </div>
                                        
                                        {% if volume.attachments %}
                                        <div class="detail-panel-title mt-2">연결 정보</div>
                                        {% for attachment in volume.attachments %}
                                        <div class="detail-panel-row">
                                            <div class="detail-panel-label">디바이스</div>
                                            <div class="detail-panel-value">{{ attachment.device }}</div>
                                        </div>
                                        <div class="detail-panel-row">
                                            <div class="detail-panel-label">연결 상태</div>
                                            <div class="detail-panel-value">{{ attachment.state }}</div>
                                        </div>
                                        <div class="detail-panel-row">
                                            <div class="detail-panel-label">연결 시간</div>
                                            <div class="detail-panel-value">{{ attachment.attach_time|replace('T', ' ')|truncate(19, True, '') }}</div>
                                        </div>
                                        <div class="detail-panel-row">
                                            <div class="detail-panel-label">종료 시 삭제</div>
                                            <div class="detail-panel-value">{{ '예' if attachment.delete_on_termination else '아니오' }}</div>
                                        </div>
                                        {% endfor %}
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                    {% else %}
                                    <div class="empty-state">
                                        <p>볼륨 정보가 없습니다.</p>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- 보안 탭 -->
                                <div class="resource-tab-content" id="instance-security-{{ loop.index }}">
                                    {% if instance.security_groups %}
                                    <div class="detail-panel-title">보안 그룹</div>
                                    {% for sg in instance.security_groups %}
                                    <div class="security-rule">
                                        <div class="security-rule-header">
                                            <div class="security-rule-title">{{ sg.group_name }}</div>
                                            <div class="security-rule-ports">{{ sg.group_id }}</div>
                                        </div>
                                        <div class="detail-panel-row">
                                            <div class="detail-panel-label">설명</div>
                                            <div class="detail-panel-value">{{ sg.description }}</div>
                                        </div>
                                        
                                        {% if sg.inbound_rules %}
                                        <div class="detail-panel-title mt-2">인바운드 규칙</div>
                                        <div class="table-responsive">
                                            <table class="resource-table">
                                                <thead>
                                                    <tr>
                                                        <th>프로토콜</th>
                                                        <th>포트 범위</th>
                                                        <th>소스</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for rule in sg.inbound_rules %}
                                                    <tr>
                                                        <td>{{ rule.protocol }}</td>
                                                        <td>
                                                            {% if rule.from_port == rule.to_port %}
                                                                {{ rule.from_port }}
                                                            {% else %}
                                                                {{ rule.from_port }}-{{ rule.to_port }}
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            {% for ip in rule.ip_ranges %}
                                                            <span class="security-rule-ip">{{ ip }}</span>
                                                            {% endfor %}
                                                            {% for ip in rule.ipv6_ranges %}
                                                            <span class="security-rule-ip">{{ ip }}</span>
                                                            {% endfor %}
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                        {% endif %}
                                        
                                        {% if sg.outbound_rules %}
                                        <div class="detail-panel-title mt-2">아웃바운드 규칙</div>
                                        <div class="table-responsive">
                                            <table class="resource-table">
                                                <thead>
                                                    <tr>
                                                        <th>프로토콜</th>
                                                        <th>포트 범위</th>
                                                        <th>대상</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for rule in sg.outbound_rules %}
                                                    <tr>
                                                        <td>{{ rule.protocol }}</td>
                                                        <td>
                                                            {% if rule.from_port == rule.to_port %}
                                                                {{ rule.from_port }}
                                                            {% else %}
                                                                {{ rule.from_port }}-{{ rule.to_port }}
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            {% for ip in rule.ip_ranges %}
                                                            <span class="security-rule-ip">{{ ip }}</span>
                                                            {% endfor %}
                                                            {% for ip in rule.ipv6_ranges %}
                                                            <span class="security-rule-ip">{{ ip }}</span>
                                                            {% endfor %}
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                    {% else %}
                                    <div class="empty-state">
                                        <p>보안 그룹 정보가 없습니다.</p>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- 태그 탭 -->
                                <div class="resource-tab-content" id="instance-tags-{{ loop.index }}">
                                    {% if instance.tags %}
                                    <div class="detail-panel-title">태그</div>
                                    <div>
                                        {% for tag in instance.tags %}
                                        <div class="resource-tag">
                                            <span class="tag-key">{{ tag.Key }}:</span>
                                            <span class="tag-value">{{ tag.Value }}</span>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% else %}
                                    <div class="empty-state">
                                        <p>태그 정보가 없습니다.</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-server"></i>
            <h3>EC2 인스턴스 데이터가 없습니다</h3>
            <p>이 계정에서 EC2 인스턴스를 찾을 수 없거나 데이터 수집 중 오류가 발생했습니다.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}<!-- S3 서비스 섹션 -->
{% if 's3' in selected_services and all_services_data.s3 %}
<div class="service-section" id="s3-section">
    <div class="service-section-header" data-bs-target="#s3-content" aria-expanded="true">
        <h3>
            <i class="fas fa-database"></i>
            S3 버킷
        </h3>
        <div class="toggle-icon">
            <i class="fas fa-chevron-down"></i>
        </div>
    </div>
    <div class="service-section-body collapse show" id="s3-content">
        <!-- S3 요약 정보 -->
        {% if all_services_data.s3.summary %}
        <div class="summary-cards">
            <div class="summary-card">
                <div class="summary-card-title">총 버킷</div>
                <div class="summary-card-value">{{ all_services_data.s3.summary.total_buckets }}</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-title">공개 버킷</div>
                <div class="summary-card-value">{{ all_services_data.s3.summary.public_buckets }}</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-title">암호화 버킷</div>
                <div class="summary-card-value">{{ all_services_data.s3.summary.encrypted_buckets }}</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-title">버전 관리 활성화</div>
                <div class="summary-card-value">{{ all_services_data.s3.summary.versioning_enabled }}</div>
            </div>
        </div>
        
        <!-- 스토리지 클래스별 분포 -->
        {% if all_services_data.s3.summary.storage_class_summary %}
        <div class="chart-container">
            <div class="chart-title">스토리지 클래스별 분포</div>
            <div class="table-responsive">
                <table class="resource-table">
                    <thead>
                        <tr>
                            <th>스토리지 클래스</th>
                            <th>객체 수</th>
                            <th>크기</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for class, data in all_services_data.s3.summary.storage_class_summary.items() %}
                        <tr>
                            <td><strong>{{ class }}</strong></td>
                            <td>{{ data.count }}</td>
                            <td>{{ (data.size_bytes / 1024 / 1024)|round(2) }} MB</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
        
        <!-- 리전별 버킷 분포 -->
        {% if all_services_data.s3.summary.region_distribution %}
        <div class="chart-container">
            <div class="chart-title">리전별 버킷 분포</div>
            <div class="table-responsive">
                <table class="resource-table">
                    <thead>
                        <tr>
                            <th>리전</th>
                            <th>총 버킷</th>
                            <th>공개</th>
                            <th>비공개</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for region, data in all_services_data.s3.summary.region_distribution.items() %}
                        <tr>
                            <td><strong>{{ region }}</strong></td>
                            <td>{{ data.count }}</td>
                            <td>{{ data.public }}</td>
                            <td>{{ data.private }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
        {% endif %}
        
        <!-- S3 버킷 목록 -->
        {% if all_services_data.s3.buckets %}
        <div class="filter-container">
            <input type="text" class="filter-input" id="s3-filter" data-table="s3-table" placeholder="버킷 필터링...">
        </div>
        <div class="table-responsive">
            <table class="resource-table" id="s3-table">
                <thead>
                    <tr>
                        <th data-sort="name">버킷 이름</th>
                        <th data-sort="region">리전</th>
                        <th data-sort="creation_date">생성 날짜</th>
                        <th data-sort="versioning">버전 관리</th>
                        <th data-sort="public">공개 액세스</th>
                        <th data-sort="encryption">암호화</th>
                        <th data-sort="size">크기</th>
                        <th>상세 정보</th>
                    </tr>
                </thead>
                <tbody>
                    {% for bucket in all_services_data.s3.buckets %}
                    <tr>
                        <td data-column="name">{{ bucket.name }}</td>
                        <td data-column="region">{{ bucket.region }}</td>
                        <td data-column="creation_date">{{ bucket.creation_date|replace('T', ' ')|truncate(19, True, '') }}</td>
                        <td data-column="versioning">
                            {% if bucket.versioning_enabled %}
                            <span class="status-badge status-running">활성화</span>
                            {% else %}
                            <span class="status-badge status-stopped">비활성화</span>
                            {% endif %}
                        </td>
                        <td data-column="public">
                            {% if bucket.public_access %}
                            <span class="status-badge status-stopped">공개</span>
                            {% else %}
                            <span class="status-badge status-running">비공개</span>
                            {% endif %}
                        </td>
                        <td data-column="encryption">
                            {% if bucket.encryption_enabled %}
                            <span class="status-badge status-running">활성화</span>
                            {% else %}
                            <span class="status-badge status-stopped">비활성화</span>
                            {% endif %}
                        </td>
                        <td data-column="size">
                            {% if bucket.size_bytes is defined %}
                            {{ (bucket.size_bytes / 1024 / 1024)|round(2) }} MB
                            {% else %}
                            N/A
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary detail-toggle" data-target="bucket-detail-{{ loop.index }}">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </td>
                    </tr>
                    <tr id="bucket-detail-{{ loop.index }}" style="display: none;">
                        <td colspan="8">
                            <div class="detail-panel">
                                <!-- 버킷 상세 정보 탭 -->
                                <div class="resource-tabs">
                                    <div class="resource-tab active" data-tab="bucket-info-{{ loop.index }}">기본 정보</div>
                                    <div class="resource-tab" data-tab="bucket-policy-{{ loop.index }}">정책</div>
                                    <div class="resource-tab" data-tab="bucket-lifecycle-{{ loop.index }}">수명 주기</div>
                                    <div class="resource-tab" data-tab="bucket-storage-{{ loop.index }}">스토리지</div>
                                    <div class="resource-tab" data-tab="bucket-tags-{{ loop.index }}">태그</div>
                                </div>
                                
                                <!-- 기본 정보 탭 -->
                                <div class="resource-tab-content active" id="bucket-info-{{ loop.index }}">
                                    <div class="detail-panel-row">
                                        <div class="detail-panel-label">버킷 이름</div>
                                        <div class="detail-panel-value">{{ bucket.name }}</div>
                                    </div>
                                    <div class="detail-panel-row">
                                        <div class="detail-panel-label">리전</div>
                                        <div class="detail-panel-value">{{ bucket.region }}</div>
                                    </div>
                                    <div class="detail-panel-row">
                                        <div class="detail-panel-label">생성 날짜</div>
                                        <div class="detail-panel-value">{{ bucket.creation_date|replace('T', ' ')|truncate(19, True, '') }}</div>
                                    </div>
                                    <div class="detail-panel-row">
                                        <div class="detail-panel-label">버전 관리</div>
                                        <div class="detail-panel-value">{{ '활성화' if bucket.versioning_enabled else '비활성화' }}</div>
                                    </div>
                                    <div class="detail-panel-row">
                                        <div class="detail-panel-label">공개 액세스</div>
                                        <div class="detail-panel-value">{{ '공개' if bucket.public_access else '비공개' }}</div>
                                    </div>
                                    <div class="detail-panel-row">
                                        <div class="detail-panel-label">암호화</div>
                                        <div class="detail-panel-value">{{ '활성화' if bucket.encryption_enabled else '비활성화' }}</div>
                                    </div>
                                    <div class="detail-panel-row">
                                        <div class="detail-panel-label">객체 수</div>
                                        <div class="detail-panel-value">{{ bucket.object_count|default('N/A') }}</div>
                                    </div>
                                    <div class="detail-panel-row">
                                        <div class="detail-panel-label">크기</div>
                                        <div class="detail-panel-value">
                                            {% if bucket.size_bytes is defined %}
                                            {{ (bucket.size_bytes / 1024 / 1024)|round(2) }} MB
                                            {% else %}
                                            N/A
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <!-- 웹사이트 설정 -->
                                    <div class="detail-panel-title mt-3">웹사이트 설정</div>
                                    {% if bucket.website_enabled %}
                                    <div class="detail-panel-row">
                                        <div class="detail-panel-label">웹사이트 활성화</div>
                                        <div class="detail-panel-value">예</div>
                                    </div>
                                    {% if bucket.website_config %}
                                    <div class="detail-panel-row">
                                        <div class="detail-panel-label">인덱스 문서</div>
                                        <div class="detail-panel-value">{{ bucket.website_config.IndexDocument.Suffix|default('N/A') }}</div>
                                    </div>
                                    <div class="detail-panel-row">
                                        <div class="detail-panel-label">오류 문서</div>
                                        <div class="detail-panel-value">{{ bucket.website_config.ErrorDocument.Key|default('N/A') }}</div>
                                    </div>
                                    {% endif %}
                                    {% else %}
                                    <div class="detail-panel-row">
                                        <div class="detail-panel-label">웹사이트 활성화</div>
                                        <div class="detail-panel-value">아니오</div>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- 로깅 설정 -->
                                    <div class="detail-panel-title mt-3">로깅 설정</div>
                                    {% if bucket.logging_enabled %}
                                    <div class="detail-panel-row">
                                        <div class="detail-panel-label">로깅 활성화</div>
                                        <div class="detail-panel-value">예</div>
                                    </div>
                                    <div class="detail-panel-row">
                                        <div class="detail-panel-label">대상 버킷</div>
                                        <div class="detail-panel-value">{{ bucket.logging_target_bucket }}</div>
                                    </div>
                                    <div class="detail-panel-row">
                                        <div class="detail-panel-label">대상 접두사</div>
                                        <div class="detail-panel-value">{{ bucket.logging_target_prefix }}</div>
                                    </div>
                                    {% else %}
                                    <div class="detail-panel-row">
                                        <div class="detail-panel-label">로깅 활성화</div>
                                        <div class="detail-panel-value">아니오</div>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- 정책 탭 -->
                                <div class="resource-tab-content" id="bucket-policy-{{ loop.index }}">
                                    {% if bucket.policy %}
                                    <div class="detail-panel-title">버킷 정책</div>
                                    <pre class="detail-panel-content">{{ bucket.policy|tojson(indent=2) }}</pre>
                                    {% else %}
                                    <div class="empty-state">
                                        <p>버킷 정책이 없습니다.</p>
                                    </div>
                                    {% endif %}
                                    
                                    {% if bucket.cors_rules %}
                                    <div class="detail-panel-title mt-3">CORS 설정</div>
                                    <pre class="detail-panel-content">{{ bucket.cors_rules|tojson(indent=2) }}</pre>
                                    {% endif %}
                                </div>
                                
                                <!-- 수명 주기 탭 -->
                                <div class="resource-tab-content" id="bucket-lifecycle-{{ loop.index }}">
                                    {% if bucket.lifecycle_rules %}
                                    <div class="detail-panel-title">수명 주기 규칙</div>
                                    {% for rule in bucket.lifecycle_rules %}
                                    <div class="security-rule">
                                        <div class="security-rule-header">
                                            <div class="security-rule-title">{{ rule.id }}</div>
                                            <div class="security-rule-ports">{{ rule.status }}</div>
                                        </div>
                                        
                                        {% if rule.prefix %}
                                        <div class="detail-panel-row">
                                            <div class="detail-panel-label">접두사</div>
                                            <div class="detail-panel-value">{{ rule.prefix }}</div>
                                        </div>
                                        {% endif %}
                                        
                                        {% if rule.filter %}
                                        <div class="detail-panel-row">
                                            <div class="detail-panel-label">필터</div>
                                            <div class="detail-panel-value">{{ rule.filter|tojson }}</div>
                                        </div>
                                        {% endif %}
                                        
                                        {% if rule.expiration %}
                                        <div class="detail-panel-title mt-2">만료 설정</div>
                                        <pre class="detail-panel-content">{{ rule.expiration|tojson(indent=2) }}</pre>
                                        {% endif %}
                                        
                                        {% if rule.transitions %}
                                        <div class="detail-panel-title mt-2">전환 설정</div>
                                        <pre class="detail-panel-content">{{ rule.transitions|tojson(indent=2) }}</pre>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                    {% else %}
                                    <div class="empty-state">
                                        <p>수명 주기 규칙이 없습니다.</p>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- 스토리지 탭 -->
                                <div class="resource-tab-content" id="bucket-storage-{{ loop.index }}">
                                    {% if bucket.storage_class_distribution %}
                                    <div class="detail-panel-title">스토리지 클래스별 분포</div>
                                    <div class="table-responsive">
                                        <table class="resource-table">
                                            <thead>
                                                <tr>
                                                    <th>스토리지 클래스</th>
                                                    <th>객체 수</th>
                                                    <th>크기</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for class, data in bucket.storage_class_distribution.items() %}
                                                <tr>
                                                    <td>{{ class }}</td>
                                                    <td>{{ data.count }}</td>
                                                    <td>{{ (data.size_bytes / 1024 / 1024)|round(2) }} MB</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% else %}
                                    <div class="empty-state">
                                        <p>스토리지 클래스 분포 정보가 없습니다.</p>
                                    </div>
                                    {% endif %}
                                    
                                    {% if bucket.access_points %}
                                    <div class="detail-panel-title mt-3">액세스 포인트</div>
                                    <div class="table-responsive">
                                        <table class="resource-table">
                                            <thead>
                                                <tr>
                                                    <th>이름</th>
                                                    <th>네트워크 원본</th>
                                                    <th>ARN</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for ap in bucket.access_points %}
                                                <tr>
                                                    <td>{{ ap.name }}</td>
                                                    <td>{{ ap.network_origin }}</td>
                                                    <td>{{ ap.access_point_arn }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- 태그 탭 -->
                                <div class="resource-tab-content" id="bucket-tags-{{ loop.index }}">
                                    {% if bucket.tags %}
                                    <div class="detail-panel-title">태그</div>
                                    <div>
                                        {% for tag in bucket.tags %}
                                        <div class="resource-tag">
                                            <span class="tag-key">{{ tag.Key }}:</span>
                                            <span class="tag-value">{{ tag.Value }}</span>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% else %}
                                    <div class="empty-state">
                                        <p>태그 정보가 없습니다.</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-database"></i>
            <h3>S3 버킷 데이터가 없습니다</h3>
            <p>이 계정에서 S3 버킷을 찾을 수 없거나 데이터 수집 중 오류가 발생했습니다.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- 다른 서비스 섹션도 비슷한 방식으로 추가 -->

{% else %}
<!-- 데이터가 없는 경우 -->
<div class="awsui-alert awsui-alert-warning">
    <div class="awsui-alert-icon">
        <i class="fas fa-exclamation-triangle"></i>
    </div>
    <div class="awsui-alert-content">
        <div class="awsui-alert-message">
            서비스 데이터를 찾을 수 없습니다. 다른 수집 데이터를 선택하거나 새로운 데이터를 수집하세요.
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/resource/service-view.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ServiceView 모듈 초기화
    ServiceView.init();
    
    // 데이터 내보내기 버튼 설정
    document.getElementById('export-json').addEventListener('click', function() {
        const data = {{ all_services_data|tojson }};
        ServiceView.exportJSON(data, 'aws-services-data');
    });
    
    document.getElementById('export-csv').addEventListener('click', function() {
        // CSV 내보내기는 현재 표시된 테이블만 내보내기
        const activeTable = document.querySelector('.service-section-body.show .resource-table');
        if (activeTable) {
            const tableId = activeTable.id;
            let data = [];
            
            if (tableId === 'ec2-table') {
                data = {{ all_services_data.ec2.instances|default([])|tojson }};
            } else if (tableId === 's3-table') {
                data = {{ all_services_data.s3.buckets|default([])|tojson }};
            }
            
            ServiceView.exportCSV(data, 'aws-' + tableId.replace('-table', ''));
        }
    });
});
</script>
{% endblock %}