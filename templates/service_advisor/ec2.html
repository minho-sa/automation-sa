{% extends "base.html" %}

{% block title %}EC2 서비스 어드바이저 - AWS 콘솔 체크{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/service-advisor.css') }}">
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-title">
        <h1>EC2 서비스 어드바이저</h1>
        <p>EC2 서비스에 대한 검사 항목을 확인하고 실행할 수 있습니다.</p>
    </div>
    <div class="page-header-actions">
        <a href="{{ url_for('service_advisor.service_advisor_view') }}" class="awsui-button awsui-button-normal">
            <i class="fas fa-arrow-left"></i> 서비스 목록으로 돌아가기
        </a>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="awsui-container">
            <h2 class="mb-4">검사 항목</h2>
            
            <div class="check-actions mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="select-all-checks">
                    <label class="form-check-label" for="select-all-checks">
                        전체 선택
                    </label>
                </div>
                <button id="run-selected-checks" class="awsui-button awsui-button-primary ml-3">
                    <i class="fas fa-play"></i> 선택한 항목 검사하기
                </button>
            </div>
            
            <div class="check-items-container">
                {% for check in checks %}
                <div class="check-item" data-check-id="{{ check.id }}">
                    <div class="check-item-header">
                        <div class="check-item-title">
                            <input type="checkbox" class="check-select" data-check-id="{{ check.id }}">
                            <h3>{{ check.name }}</h3>
                            <span class="check-item-category {{ check.category|lower }}">{{ check.category }}</span>
                            <span class="check-item-severity {{ check.severity }}">{{ check.severity }}</span>
                        </div>
                        <div class="check-item-actions">
                            <span class="last-check-date" id="last-check-date-{{ check.id }}">검사 기록 없음</span>
                            <button class="awsui-button awsui-button-primary run-check-btn" data-check-id="{{ check.id }}">
                                <i class="fas fa-play"></i> 검사하기
                            </button>
                        </div>
                    </div>
                    <div class="check-item-description">
                        {{ check.description }}
                    </div>
                    <div class="check-item-result" id="result-{{ check.id }}" style="display: none;">
                        <div class="check-result-loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span>검사 중입니다...</span>
                        </div>
                        <div class="check-result-content" style="display: none;">
                            <!-- 결과는 JavaScript로 동적 생성됩니다 -->
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 전체 선택 체크박스 이벤트 리스너
    document.getElementById('select-all-checks').addEventListener('change', function() {
        const isChecked = this.checked;
        document.querySelectorAll('.check-select').forEach(checkbox => {
            checkbox.checked = isChecked;
        });
    });
    
    // 선택한 항목 검사하기 버튼 이벤트 리스너
    document.getElementById('run-selected-checks').addEventListener('click', function() {
        const selectedChecks = Array.from(document.querySelectorAll('.check-select:checked'))
            .map(checkbox => checkbox.getAttribute('data-check-id'));
        
        if (selectedChecks.length === 0) {
            alert('검사할 항목을 선택해주세요.');
            return;
        }
        
        // 선택된 모든 항목 검사 실행
        selectedChecks.forEach(checkId => {
            runCheck(checkId);
        });
    });
    
    // 검사 실행 버튼 이벤트 리스너
    document.querySelectorAll('.run-check-btn').forEach(button => {
        button.addEventListener('click', function() {
            const checkId = this.getAttribute('data-check-id');
            runCheck(checkId);
        });
    });
    
    // 검사 실행 함수
    function runCheck(checkId) {
        const resultContainer = document.getElementById(`result-${checkId}`);
        const loadingElement = resultContainer.querySelector('.check-result-loading');
        const contentElement = resultContainer.querySelector('.check-result-content');
        const lastCheckDateElement = document.getElementById(`last-check-date-${checkId}`);
        
        // 현재 날짜와 시간 설정
        const now = new Date();
        const dateString = now.toLocaleDateString('ko-KR', { 
            year: 'numeric', 
            month: '2-digit', 
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        // 마지막 검사 날짜 업데이트
        if (lastCheckDateElement) {
            lastCheckDateElement.textContent = `마지막 검사: ${dateString}`;
        }
        
        // 결과 컨테이너 표시 및 로딩 표시
        resultContainer.style.display = 'block';
        loadingElement.style.display = 'flex';
        contentElement.style.display = 'none';
        
        // API 호출
        fetch(`/api/service-advisor/ec2/run-check`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ check_id: checkId })
        })
        .then(response => response.json())
        .then(data => {
            // 로딩 숨기기
            loadingElement.style.display = 'none';
            
            // 결과 표시
            contentElement.style.display = 'block';
            
            // 결과 상태에 따른 스타일 설정
            let statusClass = '';
            let statusIcon = '';
            
            switch(data.status) {
                case 'ok':
                    statusClass = 'success';
                    statusIcon = 'check-circle';
                    break;
                case 'warning':
                    statusClass = 'warning';
                    statusIcon = 'exclamation-triangle';
                    break;
                case 'error':
                    statusClass = 'danger';
                    statusIcon = 'times-circle';
                    break;
                case 'info':
                    statusClass = 'info';
                    statusIcon = 'info-circle';
                    break;
                default:
                    statusClass = 'secondary';
                    statusIcon = 'question-circle';
            }
            
            // 결과 HTML 생성
            let resultHtml = `
                <div class="check-result-status ${statusClass}">
                    <i class="fas fa-${statusIcon}"></i>
                    <span>${data.message}</span>
                </div>
            `;
            
            // 권장 사항이 있는 경우
            if (data.recommendations && data.recommendations.length > 0) {
                resultHtml += `
                    <div class="check-result-recommendations">
                        <h4>권장 사항</h4>
                        <ul>
                            ${data.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // 개별 리소스 상태 표시 제거
            
            // 데이터가 있는 경우 결과 테이블 생성 (접을 수 있는 섹션으로)
            if (data.data) {
                // 데이터 유형에 따라 다른 테이블 생성
                if (data.id === 'ec2-security-group' && data.data.security_groups) {
                    resultHtml += `
                        <div class="check-result-data">
                            <h4>보안 그룹 분석 (${data.data.total_groups_count}개)</h4>
                            ${createSecurityGroupTable(data.data.security_groups)}
                        </div>
                    `;
                } else if (data.id === 'ec2-instance-type' && data.data.instances) {
                    resultHtml += `
                        <div class="check-result-data">
                            <h4>인스턴스 타입 분석 (${data.data.instances.length}개)</h4>
                            ${createInstanceTypeTable(data.data.instances)}
                        </div>
                    `;
                }
            }
            
            contentElement.innerHTML = resultHtml;
        })
        .catch(error => {
            // 로딩 숨기기
            loadingElement.style.display = 'none';
            
            // 오류 표시
            contentElement.style.display = 'block';
            contentElement.innerHTML = `
                <div class="check-result-status danger">
                    <i class="fas fa-times-circle"></i>
                    <span>검사 실행 중 오류가 발생했습니다: ${error.message}</span>
                </div>
            `;
        });
    }
    
    // 보안 그룹 테이블 생성 함수
    function createSecurityGroupTable(securityGroups) {
        if (!securityGroups || securityGroups.length === 0) return '';
        
        return `
            <div class="table-responsive">
                <table class="awsui-table">
                    <thead>
                        <tr>
                            <th>보안 그룹 ID</th>
                            <th>보안 그룹 이름</th>
                            <th>위험 요소</th>
                            <th>상태</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${securityGroups.map(group => {
                            let statusClass = '';
                            let statusIcon = '';
                            let riskComment = '';
                            
                            if (group.status_code === 'ok') {
                                statusClass = 'success';
                                statusIcon = 'check-circle';
                                riskComment = '안전한 구성';
                            } else {
                                statusClass = 'warning';
                                statusIcon = 'exclamation-triangle';
                                
                                if (group.risky_rules && group.risky_rules.length > 0) {
                                    // 위험 유형 분석
                                    const hasSSH = group.risky_rules.some(r => r.port_range === '22' || (r.port_range.includes('-') && parseInt(r.port_range.split('-')[0]) <= 22 && parseInt(r.port_range.split('-')[1]) >= 22));
                                    const hasRDP = group.risky_rules.some(r => r.port_range === '3389' || (r.port_range.includes('-') && parseInt(r.port_range.split('-')[0]) <= 3389 && parseInt(r.port_range.split('-')[1]) >= 3389));
                                    const hasDB = group.risky_rules.some(r => r.port_range === '3306' || r.port_range === '5432' || (r.port_range.includes('-') && ((parseInt(r.port_range.split('-')[0]) <= 3306 && parseInt(r.port_range.split('-')[1]) >= 3306) || (parseInt(r.port_range.split('-')[0]) <= 5432 && parseInt(r.port_range.split('-')[1]) >= 5432))));
                                    const hasAllPorts = group.risky_rules.some(r => r.protocol === '-1');
                                    
                                    let risks = [];
                                    if (hasSSH) risks.push('SSH(22)');
                                    if (hasRDP) risks.push('RDP(3389)');
                                    if (hasDB) risks.push('DB 포트(3306/5432)');
                                    if (hasAllPorts) risks.push('모든 포트');
                                    
                                    riskComment = `인터넷(0.0.0.0/0)에 ${risks.join(', ')} 개방됨`;
                                } else {
                                    riskComment = '위험 규칙 정보 없음';
                                }
                            }
                            
                            return `
                                <tr>
                                    <td>${group.sg_id}</td>
                                    <td>${group.sg_name}</td>
                                    <td>${riskComment}</td>
                                    <td>
                                        <span class="resource-status ${statusClass}">
                                            <i class="fas fa-${statusIcon}"></i>
                                            ${group.status}
                                        </span>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }
    
    // 인스턴스 타입 테이블 생성 함수
    function createInstanceTypeTable(instances) {
        if (!instances || instances.length === 0) return '';
        
        return `
            <div class="table-responsive">
                <table class="awsui-table">
                    <thead>
                        <tr>
                            <th>인스턴스 ID</th>
                            <th>인스턴스 이름</th>
                            <th>인스턴스 타입</th>
                            <th>평균 CPU 사용률</th>
                            <th>최대 CPU 사용률</th>
                            <th>권장 사항</th>
                            <th>상태</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${instances.map(instance => {
                            let statusClass = '';
                            let statusIcon = '';
                            let statusText = '통과';
                            
                            if (instance.recommendation === '다운사이징 권장' || instance.recommendation === '업그레이드 권장') {
                                statusClass = 'warning';
                                statusIcon = 'exclamation-triangle';
                                statusText = '최적화 필요';
                            } else if (instance.recommendation === '적절한 크기') {
                                statusClass = 'success';
                                statusIcon = 'check-circle';
                            } else {
                                statusClass = 'info';
                                statusIcon = 'info-circle';
                                statusText = '정보';
                            }
                            
                            return `
                                <tr>
                                    <td>${instance.instance_id}</td>
                                    <td>${instance.instance_name || 'N/A'}</td>
                                    <td>${instance.instance_type}</td>
                                    <td>${instance.avg_cpu}%</td>
                                    <td>${instance.max_cpu}%</td>
                                    <td>${instance.recommendation}</td>
                                    <td>
                                        <span class="resource-status ${statusClass}">
                                            <i class="fas fa-${statusIcon}"></i>
                                            ${statusText}
                                        </span>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }
});
</script>
{% endblock %}