{% extends "base.html" %}

{% block title %}통합 대시보드 - AWS 콘솔 체크{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<style>
    /* 화살표 애니메이션 */
    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {
            transform: translateY(0);
        }
        40% {
            transform: translateY(-20px);
        }
        60% {
            transform: translateY(-10px);
        }
    }
    
    .animate-bounce {
        animation: bounce 2s infinite;
    }
</style>
{% endblock %}

{% block content %}
<div class="awsui-subheader">
    <div class="awsui-subheader-container">
        <ul class="awsui-breadcrumb">
            <li class="awsui-breadcrumb-item">
                <span class="awsui-breadcrumb-text">통합 대시보드</span>
            </li>
        </ul>
    </div>
</div>

<h1 class="mb-4">AWS 서비스 통합 대시보드</h1>
<p class="lead">모든 AWS 서비스의 정보를 한 페이지에서 확인하세요.</p>

<div class="mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <button class="awsui-button awsui-button-primary" id="expand-all">
                <i class="fas fa-chevron-down"></i>모두 펼치기
            </button>
            <button class="awsui-button awsui-button-normal ms-2" id="collapse-all">
                <i class="fas fa-chevron-up"></i>모두 접기
            </button>
            {% if not is_collecting %}
            <button class="awsui-button awsui-button-success ms-2" id="select-services-btn">
                <i class="fas fa-sync-alt"></i>데이터 수집
            </button>
            {% endif %}
        </div>
    </div>
</div>

{% if is_collecting or error %}
<div id="collection-progress-container" class="mb-4">
    <div class="awsui-card">
        <div class="awsui-card-header">
            <h5 class="mb-0"><i class="fas fa-sync-alt me-2"></i>데이터 수집 진행 상황</h5>
        </div>
        <div class="awsui-card-body">
            {% if error %}
            <div class="awsui-alert awsui-alert-error">
                <div class="awsui-alert-icon">
                    <i class="fas fa-exclamation-circle"></i>
                </div>
                <div class="awsui-alert-content">
                    <div class="awsui-alert-message">
                        <strong>오류 발생:</strong> {{ error }}
                    </div>
                </div>
            </div>
            {% else %}
            <p>현재 수집 중인 서비스: <strong id="current-service">{{ current_service }}</strong></p>
            <div class="progress mb-3">
                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" 
                     style="width: {% if total_services > 0 %}{{ (completed_services|length / total_services * 100)|round|int }}{% else %}0{% endif %}%;" 
                     aria-valuenow="{% if total_services > 0 %}{{ (completed_services|length / total_services * 100)|round|int }}{% else %}0{% endif %}" 
                     aria-valuemin="0" aria-valuemax="100">
                    {% if total_services > 0 %}{{ (completed_services|length / total_services * 100)|round|int }}{% else %}0{% endif %}%
                </div>
            </div>
            <p>완료된 서비스: <span id="completed-count">{{ completed_services|length }}</span> / <span id="total-services">{{ total_services }}</span></p>
            <div class="mb-2">
                <span class="badge bg-success me-1">완료됨</span>
                <span class="badge bg-primary me-1">수집 중</span>
                <span class="badge bg-pending me-1">수집 예정</span>
            </div>
            <div id="completed-services-list">
                {% for service in completed_services %}
                <span class="badge bg-success me-1 mb-1">{{ service }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        <div class="awsui-card-body" style="border-top: 1px solid #e9ebed; background-color: #f8f8f8; padding: 12px 20px;">
            <small style="color: #5f6b7a;">데이터 수집이 완료되면 자동으로 페이지가 새로고침됩니다.</small>
        </div>
    </div>
</div>
{% endif %}

{% if is_collecting %}
<div class="awsui-alert awsui-alert-info">
    <div class="awsui-alert-icon">
        <i class="fas fa-info-circle"></i>
    </div>
    <div class="awsui-alert-content">
        <div class="awsui-alert-message">
            데이터를 수집 중입니다. 데이터 수집이 완료되면 서비스 섹션이 표시됩니다.
        </div>
    </div>
</div>

<!-- 데이터 수집 중에는 서비스 섹션을 표시하지 않음 -->

{% elif show_collection_message %}
<div class="awsui-alert awsui-alert-warning">
    <div class="awsui-alert-icon">
        <i class="fas fa-exclamation-triangle"></i>
    </div>
    <div class="awsui-alert-content">
        <div class="awsui-alert-header">
            <h3>데이터 수집이 필요합니다!</h3>
        </div>
        <div class="awsui-alert-message">
            서비스 정보를 보기 전에 먼저 데이터를 수집해야 합니다. 위의 <strong>'데이터 수집'</strong> 버튼을 클릭하여 AWS 서비스 데이터를 수집하세요.
        </div>
    </div>
</div>

<div class="text-center my-5">
    <i class="fas fa-arrow-up fa-3x mb-3 text-primary animate-bounce"></i>
    <h3>데이터 수집 버튼을 클릭하세요</h3>
    <p class="lead">AWS 서비스 데이터를 수집한 후 서비스 정보를 확인할 수 있습니다.</p>
</div>

{% elif all_services_data %}
<!-- 데이터 수집이 완료된 경우 -->
{% include 'sections/ec2_section.html' with context %}
{% include 'sections/s3_section.html' with context %}

{% include 'sections/rds_section.html' with context %}
{% include 'sections/lambda_section.html' with context %}
{% include 'sections/cloudwatch_section.html' with context %}
{% include 'sections/iam_section.html' with context %}
{% include 'sections/dynamodb_section.html' with context %}
{% include 'sections/ecs_section.html' with context %}
{% include 'sections/eks_section.html' with context %}
{% include 'sections/elasticache_section.html' with context %}
{% include 'sections/route53_section.html' with context %}
{% include 'sections/sns_section.html' with context %}
{% include 'sections/sqs_section.html' with context %}
{% include 'sections/apigateway_section.html' with context %}

{% else %}
<!-- 데이터가 없는 경우 -->
<div class="awsui-alert awsui-alert-info">
    <div class="awsui-alert-icon">
        <i class="fas fa-info-circle"></i>
    </div>
    <div class="awsui-alert-content">
        <div class="awsui-alert-message">
            데이터가 없습니다. '데이터 수집' 버튼을 클릭하여 AWS 서비스 데이터를 수집하세요.
        </div>
    </div>
</div>
{% endif %}

<!-- 서비스 선택 모달 -->
<div class="modal fade" id="selectServicesModal" tabindex="-1" aria-labelledby="selectServicesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius: 8px; border: none; box-shadow: 0 1px 5px 0 rgba(0, 28, 36, 0.15), 0 3px 6px 0 rgba(0, 28, 36, 0.1);">
            <div class="modal-header" style="background-color: #ffffff; border-bottom: 1px solid #e9ebed;">
                <h5 class="modal-title" id="selectServicesModalLabel" style="font-size: 16px; font-weight: 700; color: #000716;">수집할 AWS 서비스 선택</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">데이터를 수집할 AWS 서비스를 선택하세요:</p>
                
                <div class="mb-3">
                    <button class="awsui-button awsui-button-primary" id="select-all-services" style="height: 28px; font-size: 12px;">
                        <i class="fas fa-check-square"></i>모두 선택
                    </button>
                    <button class="awsui-button awsui-button-normal ms-2" id="deselect-all-services" style="height: 28px; font-size: 12px;">
                        <i class="fas fa-square"></i>모두 선택 해제
                    </button>
                </div>
                
                <div class="row">
                    {% for service_key, service in services.items() %}
                    <div class="col-md-4 mb-2">
                        <div class="form-check">
                            <input class="form-check-input service-checkbox" type="checkbox" value="{{ service_key }}" id="service-{{ service_key }}" checked>
                            <label class="form-check-label" for="service-{{ service_key }}">
                                <i class="fas {{ service.icon }} me-1"></i> {{ service.name }}
                            </label>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="awsui-button awsui-button-normal" data-bs-dismiss="modal">취소</button>
                <button type="button" class="awsui-button awsui-button-primary" id="start-collection">
                    <i class="fas fa-play"></i>데이터 수집 시작
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const expandAllBtn = document.getElementById('expand-all');
    const collapseAllBtn = document.getElementById('collapse-all');
    const selectServicesBtn = document.getElementById('select-services-btn');
    const startCollectionBtn = document.getElementById('start-collection');
    const selectAllServicesBtn = document.getElementById('select-all-services');
    const deselectAllServicesBtn = document.getElementById('deselect-all-services');
    const serviceCheckboxes = document.querySelectorAll('.service-checkbox');
    
    // 모달 객체 생성
    const selectServicesModal = new bootstrap.Modal(document.getElementById('selectServicesModal'));
    
    // 데이터 수집 버튼 클릭 시 모달 표시
    if (selectServicesBtn) {
        selectServicesBtn.addEventListener('click', function() {
            // 모달 열기 전에 버튼 상태 초기화
            const startCollectionBtn = document.getElementById('start-collection');
            if (startCollectionBtn) {
                startCollectionBtn.disabled = false;
                startCollectionBtn.textContent = '데이터 수집 시작';
            }
            
            // 모달 내용 초기화
            const modalBody = document.querySelector('#selectServicesModal .modal-body');
            if (modalBody) {
                // 기존 알림 메시지 제거
                const alerts = modalBody.querySelectorAll('.alert');
                alerts.forEach(alert => alert.remove());
            }
            
            selectServicesModal.show();
        });
    }
    
    // 모두 선택 버튼
    if (selectAllServicesBtn) {
        selectAllServicesBtn.addEventListener('click', function() {
            serviceCheckboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
        });
    }
    
    // 모두 선택 해제 버튼
    if (deselectAllServicesBtn) {
        deselectAllServicesBtn.addEventListener('click', function() {
            serviceCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        });
    }
    
    // 데이터 수집 시작 버튼
    if (startCollectionBtn) {
        startCollectionBtn.addEventListener('click', function() {
            // 선택된 서비스 목록 수집
            const selectedServices = [];
            serviceCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedServices.push(checkbox.value);
                }
            });
            
            // 선택된 서비스가 없는 경우 - 이 검증은 collection-progress.js에서 처리하므로 여기서는 제거
            
            // 버튼 비활성화
            startCollectionBtn.disabled = true;
            startCollectionBtn.textContent = '처리 중...';
            
            // 데이터 수집 API 호출
            fetch('/start_collection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ selected_services: selectedServices })
            })
            .then(response => response.json())
            .then(data => {
                // 오류 메시지는 표시하지 않음 (collection-progress.js에서 처리)
                if (data.status === 'success') {
                    // 진행 상황은 collection-progress.js에서 처리
                } else {
                    // 오류 메시지는 표시하지 않음 (collection-progress.js에서 처리)
                    
                    // 버튼 상태 복원
                    startCollectionBtn.disabled = false;
                    startCollectionBtn.textContent = '데이터 수집 시작';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('데이터 수집 요청 중 오류가 발생했습니다.');
                
                // 버튼 상태 복원
                startCollectionBtn.disabled = false;
                startCollectionBtn.textContent = '데이터 수집 시작';
            });
        });
    }
    
    // 수집 상태 주기적으로 확인
    let statusCheckInterval;
    let modalStatusCheckInterval;
    
    function checkCollectionStatus() {
        fetch('/collection_status')
            .then(response => response.json())
            .then(data => {
                // 수집 중인 경우
                if (data.is_collecting) {
                    // 진행 상태 업데이트
                    const currentServiceElement = document.getElementById('current-service');
                    const progressBarElement = document.getElementById('progress-bar');
                    const completedCountElement = document.getElementById('completed-count');
                    const totalServicesElement = document.getElementById('total-services');
                    const completedServicesListElement = document.getElementById('completed-services-list');
                    
                    if (currentServiceElement) currentServiceElement.textContent = data.current_service || '준비 중...';
                    if (progressBarElement) {
                        progressBarElement.style.width = data.progress + '%';
                        progressBarElement.textContent = data.progress + '%';
                        progressBarElement.setAttribute('aria-valuenow', data.progress);
                    }
                    if (completedCountElement) completedCountElement.textContent = data.completed_services.length;
                    if (totalServicesElement) totalServicesElement.textContent = data.total_services;
                    
                    // 완료된 서비스 목록 업데이트
                    if (completedServicesListElement) {
                        completedServicesListElement.innerHTML = '';
                        data.completed_services.forEach(service => {
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-success me-1 mb-1';
                            badge.textContent = service;
                            completedServicesListElement.appendChild(badge);
                        });
                    }
                } else {
                    // 수집이 완료된 경우
                    if (data.error) {
                        // 오류가 있는 경우
                        alert('데이터 수집 중 오류가 발생했습니다: ' + data.error);
                    } else if (data.completed_services && data.completed_services.length > 0) {
                        // 수집이 성공적으로 완료된 경우
                        // 페이지 새로고침
                        location.reload();
                    }
                    
                    // 상태 확인 중지
                    clearInterval(statusCheckInterval);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }
    
    // 이 함수는 collection-progress.js로 이동했습니다
    
    // 이 함수는 collection-progress.js로 이동했습니다
    
    // 페이지 로드 시 수집 상태 확인 시작
    if (document.getElementById('collection-progress-container')) {
        statusCheckInterval = setInterval(checkCollectionStatus, 2000);
        checkCollectionStatus(); // 즉시 한 번 확인
    }
    
    expandAllBtn.addEventListener('click', function() {
        // card-header와 awsui-card-header 클래스를 가진 요소 모두 선택
        const accordionButtons = document.querySelectorAll('.card-header[data-bs-toggle="collapse"].collapsed, .awsui-card-header[data-bs-toggle="collapse"].collapsed');
        accordionButtons.forEach(button => {
            const targetId = button.getAttribute('data-bs-target');
            const target = document.querySelector(targetId);
            if (!target.classList.contains('show')) {
                button.click();
            }
        });
    });
    
    collapseAllBtn.addEventListener('click', function() {
        // card-header와 awsui-card-header 클래스를 가진 요소 모두 선택
        const accordionButtons = document.querySelectorAll('.card-header[data-bs-toggle="collapse"]:not(.collapsed), .awsui-card-header[data-bs-toggle="collapse"]:not(.collapsed)');
        accordionButtons.forEach(button => {
            const targetId = button.getAttribute('data-bs-target');
            const target = document.querySelector(targetId);
            if (target.classList.contains('show')) {
                button.click();
            }
        });
    });
});
</script>
    
{% endblock %}