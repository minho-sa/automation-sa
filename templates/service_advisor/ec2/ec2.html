{% extends "service_advisor/common/base.html" %}

{% block title %}EC2 서비스 어드바이저 - AWS 콘솔 체크{% endblock %}

{% block advisor_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/service-advisor/ec2.css') }}">
{% endblock %}

{% block advisor_title %}EC2 서비스 어드바이저{% endblock %}
{% block advisor_description %}EC2 인스턴스 최적화 및 비용 절감 추천{% endblock %}

{% block advisor_actions %}
<button class="awsui-button awsui-button-primary scan-button" data-service-type="ec2" data-scan-url="{{ url_for('service_advisor.ec2_scan', service_name='ec2') }}">
    <i class="fas fa-search"></i> 검사 시작
</button>
{% if report %}
<button class="awsui-button awsui-button-normal export-pdf-button" data-report-id="{{ report.id }}" data-export-url="{{ url_for('service_advisor.export_pdf') }}">
    <i class="fas fa-file-pdf"></i> PDF 내보내기
</button>
{% endif %}
{% endblock %}

{% block advisor_content %}
{% if report %}
<div class="summary-metrics">
    <div class="summary-metric summary-metric-high">
        <div class="summary-metric-title">높은 심각도</div>
        <div class="summary-metric-value">{{ high_count }}</div>
    </div>
    <div class="summary-metric summary-metric-medium">
        <div class="summary-metric-title">중간 심각도</div>
        <div class="summary-metric-value">{{ medium_count }}</div>
    </div>
    <div class="summary-metric summary-metric-low">
        <div class="summary-metric-title">낮은 심각도</div>
        <div class="summary-metric-value">{{ low_count }}</div>
    </div>
    <div class="summary-metric">
        <div class="summary-metric-title">검사 날짜</div>
        <div class="summary-metric-value" style="font-size: 16px;">{{ report.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
    </div>
</div>

<div class="awsui-card mb-4">
    <div class="awsui-card-header">
        <h5><i class="fas fa-filter"></i> 필터</h5>
    </div>
    <div class="awsui-card-body">
        <div class="d-flex gap-2">
            <button class="instance-detail-btn ec2-filter-button selected" data-filter="all">모두</button>
            <button class="instance-detail-btn ec2-filter-button" data-filter="high">높은 심각도</button>
            <button class="instance-detail-btn ec2-filter-button" data-filter="medium">중간 심각도</button>
            <button class="instance-detail-btn ec2-filter-button" data-filter="low">낮은 심각도</button>
        </div>
    </div>
</div>

{% for check in checks %}
<div class="recommendation-card" data-severity="{{ check.severity }}">
    <div class="recommendation-header">
        <h5 class="recommendation-title">{{ check.title }}</h5>
        <div class="d-flex align-items-center">
            <span class="severity-badge severity-{{ check.severity }} me-3">{{ check.severity|capitalize }}</span>
            <span class="toggle-icon"><i class="fas fa-chevron-down"></i></span>
        </div>
    </div>
    <div class="recommendation-body" style="display: none;">
        <div class="recommendation-description">
            {{ check.description }}
        </div>
        
        {% if check.resources %}
        <div class="recommendation-resources">
            <div class="recommendation-resources-title">영향 받는 리소스</div>
            <ul class="resource-list">
                {% for resource in check.resources %}
                <li class="resource-item">
                    <div class="resource-name">{{ resource.id }}</div>
                    <div class="resource-details">{{ resource.details }}</div>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        
        <div class="mt-3">
            <strong>권장 조치:</strong>
            <p>{{ check.recommendation }}</p>
        </div>
    </div>
</div>
{% endfor %}

{% for instance in instances %}
<div class="ec2-instance-card">
    <div class="ec2-instance-header">
        <div>
            <span class="ec2-instance-id">{{ instance.id }}</span>
            <span class="ec2-instance-type">{{ instance.instance_type }}</span>
        </div>
        <span class="toggle-icon"><i class="fas fa-chevron-down"></i></span>
    </div>
    <div class="ec2-instance-body" style="display: none;">
        <div class="ec2-metrics">
            <div class="ec2-metric">
                <div class="ec2-metric-title">평균 CPU 사용률</div>
                <div class="ec2-metric-value">{{ instance.metrics.cpu_avg }}%</div>
            </div>
            <div class="ec2-metric">
                <div class="ec2-metric-title">최대 CPU 사용률</div>
                <div class="ec2-metric-value">{{ instance.metrics.cpu_max }}%</div>
            </div>
            <div class="ec2-metric">
                <div class="ec2-metric-title">평균 메모리 사용률</div>
                <div class="ec2-metric-value">{{ instance.metrics.memory_avg }}%</div>
            </div>
            <div class="ec2-metric">
                <div class="ec2-metric-title">최대 메모리 사용률</div>
                <div class="ec2-metric-value">{{ instance.metrics.memory_max }}%</div>
            </div>
        </div>
        
        <div class="ec2-usage-chart" data-instance-id="{{ instance.id }}" data-chart-type="cpu"></div>
        
        {% if instance.recommendation %}
        <div class="instance-type-recommendation">
            <div class="instance-type-recommendation-header">인스턴스 타입 추천</div>
            <div class="instance-type-comparison">
                <div class="instance-type-current">
                    <div class="instance-type-label">현재 인스턴스 타입</div>
                    <div class="instance-type-specs">
                        <div><strong>{{ instance.instance_type }}</strong></div>
                        <div>vCPU: {{ instance.specs.vcpu }}</div>
                        <div>메모리: {{ instance.specs.memory }} GB</div>
                        <div>월 비용: ${{ instance.specs.monthly_cost }}</div>
                    </div>
                </div>
                <div class="instance-type-recommended">
                    <div class="instance-type-label">추천 인스턴스 타입</div>
                    <div class="instance-type-specs">
                        <div><strong>{{ instance.recommendation.instance_type }}</strong></div>
                        <div>vCPU: {{ instance.recommendation.vcpu }}</div>
                        <div>메모리: {{ instance.recommendation.memory }} GB</div>
                        <div>월 비용: ${{ instance.recommendation.monthly_cost }}</div>
                    </div>
                </div>
            </div>
            <div class="instance-type-savings">
                예상 월 절감액: ${{ instance.recommendation.savings }} ({{ instance.recommendation.savings_percentage }}%)
            </div>
        </div>
        {% endif %}
        
        {% if instance.tags %}
        <div class="ec2-tags">
            {% for tag in instance.tags %}
            <span class="ec2-tag">
                <span class="ec2-tag-key">{{ tag.key }}:</span>
                <span class="ec2-tag-value">{{ tag.value }}</span>
            </span>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>
{% endfor %}

{% else %}
<div class="awsui-card">
    <div class="awsui-card-body text-center py-5">
        <div class="mb-3">
            <i class="fas fa-search fa-3x text-muted"></i>
        </div>
        <h3>EC2 검사 시작하기</h3>
        <p class="text-muted">EC2 인스턴스 최적화 및 비용 절감 기회를 확인하려면 검사를 시작하세요.</p>
        <button class="awsui-button awsui-button-primary scan-button mt-3" data-service-type="ec2" data-scan-url="{{ url_for('service_advisor.ec2_scan', service_name='ec2') }}">
            <i class="fas fa-search"></i> 검사 시작
        </button>
    </div>
</div>
{% endif %}
{% endblock %}

{% block advisor_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/pages/service-advisor/ec2.js') }}"></script>
{% endblock %}