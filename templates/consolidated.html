{% extends "base.html" %}

{% block title %}통합 대시보드 - AWS 콘솔 체크{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<style>
    /* 화살표 애니메이션 */
    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {
            transform: translateY(0);
        }
        40% {
            transform: translateY(-20px);
        }
        60% {
            transform: translateY(-10px);
        }
    }
    
    .animate-bounce {
        animation: bounce 2s infinite;
    }
</style>
{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item active">통합 대시보드</li>
    </ol>
</nav>

<h1 class="mb-4">AWS 서비스 통합 대시보드</h1>
<p class="lead">모든 AWS 서비스의 정보를 한 페이지에서 확인하세요.</p>

<div class="mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <button class="btn btn-primary" id="expand-all">모두 펼치기</button>
            <button class="btn btn-outline-secondary ms-2" id="collapse-all">모두 접기</button>
            {% if not is_collecting %}
            <button class="btn btn-success ms-2" id="select-services-btn">데이터 수집</button>
            {% endif %}
        </div>
    </div>
</div>

{% if is_collecting or error %}
<div id="collection-progress-container" class="mb-4">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">데이터 수집 진행 상황</h5>
        </div>
        <div class="card-body">
            {% if error %}
            <div class="alert alert-danger">
                <strong>오류 발생:</strong> {{ error }}
            </div>
            {% else %}
            <p>현재 수집 중인 서비스: <strong id="current-service">{{ current_service }}</strong></p>
            <div class="progress mb-3">
                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" 
                     style="width: {% if total_services > 0 %}{{ (completed_services|length / total_services * 100)|round|int }}{% else %}0{% endif %}%;" 
                     aria-valuenow="{% if total_services > 0 %}{{ (completed_services|length / total_services * 100)|round|int }}{% else %}0{% endif %}" 
                     aria-valuemin="0" aria-valuemax="100">
                    {% if total_services > 0 %}{{ (completed_services|length / total_services * 100)|round|int }}{% else %}0{% endif %}%
                </div>
            </div>
            <p>완료된 서비스: <span id="completed-count">{{ completed_services|length }}</span> / <span id="total-services">{{ total_services }}</span></p>
            <div class="mb-2">
                <span class="badge bg-success me-1">완료됨</span>
                <span class="badge bg-primary me-1">수집 중</span>
                <span class="badge bg-pending me-1">수집 예정</span>
            </div>
            <div id="completed-services-list">
                {% for service in completed_services %}
                <span class="badge bg-success me-1 mb-1">{{ service }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        <div class="card-footer">
            <small class="text-muted">데이터 수집이 완료되면 자동으로 페이지가 새로고침됩니다.</small>
        </div>
    </div>
</div>
{% endif %}

{% if is_collecting %}
<div class="alert alert-info mb-4">
    <p>데이터를 수집 중입니다. 데이터 수집이 완료되면 서비스 섹션이 표시됩니다.</p>
</div>

<!-- 데이터 수집 중에는 서비스 섹션을 표시하지 않음 -->

{% elif show_collection_message %}
<div class="alert alert-warning mb-4">
    <div class="d-flex align-items-center">
        <i class="fas fa-exclamation-triangle me-3 fs-4"></i>
        <div>
            <h4 class="alert-heading">데이터 수집이 필요합니다!</h4>
            <p class="mb-0">서비스 정보를 보기 전에 먼저 데이터를 수집해야 합니다. 위의 <strong>'데이터 수집'</strong> 버튼을 클릭하여 AWS 서비스 데이터를 수집하세요.</p>
        </div>
    </div>
</div>

<div class="text-center my-5">
    <i class="fas fa-arrow-up fa-3x mb-3 text-primary animate-bounce"></i>
    <h3>데이터 수집 버튼을 클릭하세요</h3>
    <p class="lead">AWS 서비스 데이터를 수집한 후 서비스 정보를 확인할 수 있습니다.</p>
</div>

{% elif all_services_data %}
<!-- 데이터 수집이 완료된 경우 - 선택한 서비스만 표시 -->
{% if 'ec2' in selected_services %}
    {% include 'sections/ec2_section.html' with context %}
{% endif %}

{% if 's3' in selected_services %}
    {% include 'sections/s3_section.html' with context %}
{% endif %}

{% if 'rds' in selected_services %}
    {% include 'sections/rds_section.html' with context %}
{% endif %}

{% if 'lambda' in selected_services %}
    {% include 'sections/lambda_section.html' with context %}
{% endif %}

{% if 'cloudwatch' in selected_services %}
    {% include 'sections/cloudwatch_section.html' with context %}
{% endif %}

{% if 'iam' in selected_services %}
    {% include 'sections/iam_section.html' with context %}
{% endif %}

{% if 'dynamodb' in selected_services %}
    {% include 'sections/dynamodb_section.html' with context %}
{% endif %}

{% if 'ecs' in selected_services %}
    {% include 'sections/ecs_section.html' with context %}
{% endif %}

{% if 'eks' in selected_services %}
    {% include 'sections/eks_section.html' with context %}
{% endif %}

{% if 'elasticache' in selected_services %}
    {% include 'sections/elasticache_section.html' with context %}
{% endif %}

{% if 'route53' in selected_services %}
    {% include 'sections/route53_section.html' with context %}
{% endif %}

{% if 'sns' in selected_services %}
    {% include 'sections/sns_section.html' with context %}
{% endif %}

{% if 'sqs' in selected_services %}
    {% include 'sections/sqs_section.html' with context %}
{% endif %}

{% if 'apigateway' in selected_services %}
    {% include 'sections/apigateway_section.html' with context %}
{% endif %}

{% else %}
<!-- 데이터가 없는 경우 -->
<div class="alert alert-info">
    <p>데이터가 없습니다. '데이터 수집' 버튼을 클릭하여 AWS 서비스 데이터를 수집하세요.</p>
</div>
{% endif %}

<!-- 서비스 선택 모달 -->
<div class="modal fade" id="selectServicesModal" tabindex="-1" aria-labelledby="selectServicesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="selectServicesModalLabel">수집할 AWS 서비스 선택</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">데이터를 수집할 AWS 서비스를 선택하세요:</p>
                
                <div class="mb-3">
                    <button class="btn btn-sm btn-outline-primary" id="select-all-services">모두 선택</button>
                    <button class="btn btn-sm btn-outline-secondary ms-2" id="deselect-all-services">모두 선택 해제</button>
                </div>
                
                <div class="row">
                    {% for service_key, service in services.items() %}
                    <div class="col-md-4 mb-2">
                        <div class="form-check">
                            <input class="form-check-input service-checkbox" type="checkbox" value="{{ service_key }}" id="service-{{ service_key }}" checked>
                            <label class="form-check-label" for="service-{{ service_key }}">
                                <i class="fas {{ service.icon }} me-1"></i> {{ service.name }}
                            </label>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" id="start-collection">데이터 수집 시작</button>
            </div>
        </div>
    </div>
</div>

<script>
// 서비스 정보를 전역 변수로 저장
let servicesData = {};

document.addEventListener('DOMContentLoaded', function() {
    // 서버에서 전달된 서비스 정보를 JavaScript 객체로 변환
    servicesData = {
        {% for service_key, service in services.items() %}
            "{{ service_key }}": { "name": "{{ service.name }}", "icon": "{{ service.icon }}" }{% if not loop.last %},{% endif %}
        {% endfor %}
    };
    const expandAllBtn = document.getElementById('expand-all');
    const collapseAllBtn = document.getElementById('collapse-all');
    const selectServicesBtn = document.getElementById('select-services-btn');
    const startCollectionBtn = document.getElementById('start-collection');
    const selectAllServicesBtn = document.getElementById('select-all-services');
    const deselectAllServicesBtn = document.getElementById('deselect-all-services');
    const serviceCheckboxes = document.querySelectorAll('.service-checkbox');
    
    // 모달 객체 생성
    const selectServicesModalElement = document.getElementById('selectServicesModal');
    const selectServicesModal = new bootstrap.Modal(selectServicesModalElement);
    
    // 모달 닫기 버튼에 이벤트 리스너 추가
    selectServicesModalElement.querySelector('.btn-close').addEventListener('click', function() {
        selectServicesModal.hide();
    });
    
    // 취소 버튼에 이벤트 리스너 추가
    const cancelBtn = selectServicesModalElement.querySelector('.modal-footer .btn-secondary');
    if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
            selectServicesModal.hide();
        });
    }
    
    // 데이터 수집 버튼 클릭 시 모달 표시
    if (selectServicesBtn) {
        selectServicesBtn.addEventListener('click', function() {
            // 모달 열기 전에 버튼 상태 초기화
            const startCollectionBtn = document.getElementById('start-collection');
            if (startCollectionBtn) {
                startCollectionBtn.disabled = false;
                startCollectionBtn.textContent = '데이터 수집 시작';
            }
            
            // 모달 내용 초기화
            const modalBody = document.querySelector('#selectServicesModal .modal-body');
            if (modalBody) {
                // 기존 알림 메시지 제거
                const alerts = modalBody.querySelectorAll('.alert');
                alerts.forEach(alert => alert.remove());
            }
            
            selectServicesModal.show();
        });
    }
    
    // 모두 선택 버튼
    if (selectAllServicesBtn) {
        selectAllServicesBtn.addEventListener('click', function() {
            serviceCheckboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
        });
    }
    
    // 모두 선택 해제 버튼
    if (deselectAllServicesBtn) {
        deselectAllServicesBtn.addEventListener('click', function() {
            serviceCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        });
    }
    
    // 데이터 수집 시작 버튼
    if (startCollectionBtn) {
        startCollectionBtn.addEventListener('click', function() {
            // 선택된 서비스 목록 수집
            const selectedServices = [];
            serviceCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedServices.push(checkbox.value);
                }
            });
            
            // 선택된 서비스가 없는 경우
            if (selectedServices.length === 0) {
                alert('최소한 하나 이상의 서비스를 선택해야 합니다.');
                return;
            }
            
            // 버튼 비활성화
            startCollectionBtn.disabled = true;
            startCollectionBtn.textContent = '처리 중...';
            
            // 데이터 수집 API 호출
            fetch('/start_collection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ selected_services: selectedServices })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // 모달 내용을 진행 상황 표시로 변경
                    const modalBody = document.querySelector('#selectServicesModal .modal-body');
                    const modalTitle = document.querySelector('#selectServicesModal .modal-title');
                    const modalFooter = document.querySelector('#selectServicesModal .modal-footer');
                    
                    modalTitle.textContent = '데이터 수집 진행 중';
                    
                    // 진행 상황 표시 HTML 생성
                    modalBody.innerHTML = `
                        <p>선택한 서비스의 데이터를 수집하고 있습니다.</p>
                        <p>현재 수집 중인 서비스: <strong id="modal-current-service">준비 중...</strong></p>
                        <div class="progress mb-3">
                            <div id="modal-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                0%
                            </div>
                        </div>
                        <p>완료된 서비스: <span id="modal-completed-count">0</span> / <span id="modal-total-services">${selectedServices.length}</span></p>
                        <div class="mb-2">
                            <span class="badge bg-success me-1">완료됨</span>
                            <span class="badge bg-primary me-1">수집 중</span>
                            <span class="badge bg-secondary me-1">수집 예정</span>
                        </div>
                        <div id="modal-completed-services-list"></div>
                    `;
                    
                    // 모달 푸터 변경
                    modalFooter.innerHTML = `
                        <button type="button" class="btn btn-secondary" onclick="document.querySelector('#selectServicesModal .btn-close').click()">백그라운드에서 계속</button>
                    `;
                    
                    // 상태 확인 시작
                    startModalStatusCheck();
                } else {
                    // 오류 메시지 표시
                    alert('오류: ' + data.message);
                    
                    // 버튼 상태 복원
                    startCollectionBtn.disabled = false;
                    startCollectionBtn.textContent = '데이터 수집 시작';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('데이터 수집 요청 중 오류가 발생했습니다.');
                
                // 버튼 상태 복원
                startCollectionBtn.disabled = false;
                startCollectionBtn.textContent = '데이터 수집 시작';
            });
        });
    }
    
    // 수집 상태 주기적으로 확인
    let statusCheckInterval;
    let modalStatusCheckInterval;
    
    function checkCollectionStatus() {
        fetch('/collection_status')
            .then(response => response.json())
            .then(data => {
                // 수집 중인 경우
                if (data.is_collecting) {
                    // 진행 상태 업데이트
                    const currentServiceElement = document.getElementById('current-service');
                    const progressBarElement = document.getElementById('progress-bar');
                    const completedCountElement = document.getElementById('completed-count');
                    const totalServicesElement = document.getElementById('total-services');
                    const completedServicesListElement = document.getElementById('completed-services-list');
                    
                    if (currentServiceElement) currentServiceElement.textContent = data.current_service || '준비 중...';
                    if (progressBarElement) {
                        progressBarElement.style.width = data.progress + '%';
                        progressBarElement.textContent = data.progress + '%';
                        progressBarElement.setAttribute('aria-valuenow', data.progress);
                    }
                    if (completedCountElement) completedCountElement.textContent = data.completed_services.length;
                    if (totalServicesElement) totalServicesElement.textContent = data.total_services;
                    
                    // 완료된 서비스 목록 업데이트
                    if (completedServicesListElement) {
                        completedServicesListElement.innerHTML = '';
                        
                        // 이미 표시된 서비스 추적
                        const displayedServices = new Set();
                        
                        // 완료된 서비스 배지 추가
                        data.completed_services.forEach(service => {
                            displayedServices.add(service);
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-success me-1 mb-1';
                            badge.textContent = service;
                            completedServicesListElement.appendChild(badge);
                        });
                        
                        // 현재 수집 중인 서비스 배지 추가
                        if (data.current_service && !displayedServices.has(data.current_service)) {
                            displayedServices.add(data.current_service);
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-primary me-1 mb-1';
                            badge.textContent = data.current_service + ' (수집 중)';
                            completedServicesListElement.appendChild(badge);
                        }
                        
                        // 수집 예정인 서비스 배지 추가 - 서비스 이름 직접 매핑
                        const serviceNameMap = {
                            'ec2': 'EC2',
                            's3': 'S3',
                            'rds': 'RDS',
                            'lambda': 'Lambda',
                            'cloudwatch': 'CloudWatch',
                            'iam': 'IAM',
                            'dynamodb': 'DynamoDB',
                            'ecs': 'ECS',
                            'eks': 'EKS',
                            'sns': 'SNS',
                            'sqs': 'SQS',
                            'apigateway': 'API Gateway',
                            'elasticache': 'ElastiCache',
                            'route53': 'Route 53'
                        };
                        
                        if (data.selected_services) {
                            data.selected_services.forEach(serviceKey => {
                                const serviceName = serviceNameMap[serviceKey];
                                if (serviceName && !displayedServices.has(serviceName)) {
                                    displayedServices.add(serviceName);
                                    const badge = document.createElement('span');
                                    badge.className = 'badge bg-pending me-1 mb-1';
                                    badge.textContent = serviceName;
                                    completedServicesListElement.appendChild(badge);
                                }
                            });
                        }
                    }
                } else {
                    // 수집이 완료된 경우
                    if (data.error) {
                        // 오류가 있는 경우
                        alert('데이터 수집 중 오류가 발생했습니다: ' + data.error);
                    } else if (data.completed_services && data.completed_services.length > 0) {
                        // 수집이 성공적으로 완료된 경우
                        // 페이지 새로고침 (캐시 무효화)
                        location.href = location.pathname + '?t=' + new Date().getTime();
                    }
                    
                    // 상태 확인 중지
                    clearInterval(statusCheckInterval);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }
    
    // 모달 상태 확인 함수
    function startModalStatusCheck() {
        // 이전 인터벌이 있으면 제거
        if (modalStatusCheckInterval) {
            clearInterval(modalStatusCheckInterval);
        }
        
        // 새로운 인터벌 시작
        modalStatusCheckInterval = setInterval(checkModalCollectionStatus, 1000);
        checkModalCollectionStatus(); // 즉시 한 번 확인
    }
    
    // 모달 내 수집 상태 확인 함수
    function checkModalCollectionStatus() {
        fetch('/collection_status')
            .then(response => response.json())
            .then(data => {
                // 모달 내 요소 업데이트
                const currentServiceElement = document.getElementById('modal-current-service');
                const progressBarElement = document.getElementById('modal-progress-bar');
                const completedCountElement = document.getElementById('modal-completed-count');
                const totalServicesElement = document.getElementById('modal-total-services');
                const completedServicesListElement = document.getElementById('modal-completed-services-list');
                
                if (data.is_collecting) {
                    // 수집 중인 경우
                    if (currentServiceElement) currentServiceElement.textContent = data.current_service || '준비 중...';
                    if (progressBarElement) {
                        progressBarElement.style.width = data.progress + '%';
                        progressBarElement.textContent = data.progress + '%';
                        progressBarElement.setAttribute('aria-valuenow', data.progress);
                    }
                    if (completedCountElement) completedCountElement.textContent = data.completed_services.length;
                    if (totalServicesElement) totalServicesElement.textContent = data.total_services;
                    
                    // 완료된 서비스 목록 업데이트
                    if (completedServicesListElement) {
                        completedServicesListElement.innerHTML = '';
                        
                        // 이미 표시된 서비스 추적
                        const displayedServices = new Set();
                        
                        // 완료된 서비스 배지 추가
                        data.completed_services.forEach(service => {
                            displayedServices.add(service);
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-success me-1 mb-1';
                            badge.textContent = service;
                            completedServicesListElement.appendChild(badge);
                        });
                        
                        // 현재 수집 중인 서비스 배지 추가
                        if (data.current_service && !displayedServices.has(data.current_service)) {
                            displayedServices.add(data.current_service);
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-primary me-1 mb-1';
                            badge.textContent = data.current_service + ' (수집 중)';
                            completedServicesListElement.appendChild(badge);
                        }
                        
                        // 수집 예정인 서비스 배지 추가 - 서비스 이름 직접 매핑
                        const serviceNameMap = {
                            'ec2': 'EC2',
                            's3': 'S3',
                            'rds': 'RDS',
                            'lambda': 'Lambda',
                            'cloudwatch': 'CloudWatch',
                            'iam': 'IAM',
                            'dynamodb': 'DynamoDB',
                            'ecs': 'ECS',
                            'eks': 'EKS',
                            'sns': 'SNS',
                            'sqs': 'SQS',
                            'apigateway': 'API Gateway',
                            'elasticache': 'ElastiCache',
                            'route53': 'Route 53'
                        };
                        
                        if (data.selected_services) {
                            data.selected_services.forEach(serviceKey => {
                                const serviceName = serviceNameMap[serviceKey];
                                if (serviceName && !displayedServices.has(serviceName)) {
                                    displayedServices.add(serviceName);
                                    const badge = document.createElement('span');
                                    badge.className = 'badge bg-secondary me-1 mb-1';
                                    badge.textContent = serviceName;
                                    completedServicesListElement.appendChild(badge);
                                }
                            });
                        }
                    }
                } else {
                    // 수집이 완료된 경우
                    if (data.error) {
                        // 오류가 있는 경우
                        const modalBody = document.querySelector('#selectServicesModal .modal-body');
                        modalBody.innerHTML += `<div class="alert alert-danger mt-3">오류: ${data.error}</div>`;
                        
                        // 3초 후 모달 닫기
                        setTimeout(() => {
                            document.querySelector('#selectServicesModal .btn-close').click();
                            location.href = location.pathname + '?t=' + new Date().getTime(); // 캐시 방지를 위한 쿼리 파라미터 추가
                        }, 3000);
                    } else if (data.completed_services && data.completed_services.length > 0) {
                        // 수집이 성공적으로 완료된 경우
                        const modalBody = document.querySelector('#selectServicesModal .modal-body');
                        modalBody.innerHTML += `<div class="alert alert-success mt-3">데이터 수집이 완료되었습니다!</div>`;
                        
                        // 1초 후 모달 닫고 페이지 새로고침 (캐시 무효화)
                        setTimeout(() => {
                            document.querySelector('#selectServicesModal .btn-close').click();
                            location.href = location.pathname + '?t=' + new Date().getTime(); // 캐시 방지를 위한 쿼리 파라미터 추가
                        }, 1000);
                    }
                    
                    // 상태 확인 중지
                    clearInterval(modalStatusCheckInterval);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }
    
    // 페이지 로드 시 수집 상태 확인 시작
    if (document.getElementById('collection-progress-container')) {
        statusCheckInterval = setInterval(checkCollectionStatus, 2000);
        checkCollectionStatus(); // 즉시 한 번 확인
    }
    
    expandAllBtn.addEventListener('click', function() {
        // card-header 클래스를 가진 요소 내의 버튼만 선택
        const accordionButtons = document.querySelectorAll('.card-header[data-bs-toggle="collapse"].collapsed');
        accordionButtons.forEach(button => {
            const targetId = button.getAttribute('data-bs-target');
            const target = document.querySelector(targetId);
            if (!target.classList.contains('show')) {
                button.click();
            }
        });
    });
    
    collapseAllBtn.addEventListener('click', function() {
        // card-header 클래스를 가진 요소 내의 버튼만 선택
        const accordionButtons = document.querySelectorAll('.card-header[data-bs-toggle="collapse"]:not(.collapsed)');
        accordionButtons.forEach(button => {
            const targetId = button.getAttribute('data-bs-target');
            const target = document.querySelector(targetId);
            if (target.classList.contains('show')) {
                button.click();
            }
        });
    });
});
</script>
    
{% endblock %}